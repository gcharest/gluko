# Implementation: v0.1 MVP

## Overview

This document provides implementation details for v0.1, the MVP that establishes core application foundation with functional carb calculator, nutrient search, multi-subject tracking, and persistent data storage using IndexedDB for offline-first operation. See the [release planning document](../releases/v0.1-mvp.md) for goals and context.

## Architecture

### High-Level Flow

```text
User Opens App
    ↓
Service Worker loads cached app shell
    ↓
App shell loads (fast, interactive)
    ↓
App fetches dataset from IndexedDB (already cached from install)
    ↓
Search/Calculator/History views become available
    ↓
User can work fully offline
```

### Key Components

1. **App Shell**: HTML/CSS/JS with responsive layout
   - Navigation bar and footer
   - Search, calculator, and history views
   - Bootstrap 5 for responsive design
   - Bilingual support (EN/FR via vue-i18n)

2. **Service Worker**: Caches static assets
   - vite-plugin-pwa integration
   - Cache-first strategy for assets
   - Lifecycle: Install (cache assets), activate (clean old caches), fetch (serve cached)

3. **IndexedDB**: Stores dataset and user data
   - Stores:
     - `nutrientsFile`: Full CNF dataset (~7000 foods)
     - `favoriteNutrients`: Favorite foods
     - `subjects`: Multi-subject profiles (name, target macros)
     - `sessions`: Session management
     - `mealHistory`: Complete meal records with all nutrients
   - Indexes: `by-subject`, `by-date`, `by-active`, `by-name`
   - Date serialization/deserialization for storage compatibility

4. **State Management** (Pinia stores):
   - `nutrientsFile`: Dataset storage and fuzzy search (explicit return types)
   - `meal`: Current meal calculation (transaction-safe multi-subject sessions)
   - `mealHistory`: Persistent meal records (atomic IndexedDB writes)
   - `subject`: Multi-subject management (proper data isolation)
   - `session`: Session tracking (continuous persistence pattern)

5. **Vue Components**: Three main views
   - **Search View**: Fuzzy search of nutrient database with favorites
   - **Calculator View**: Add foods to meal, calculate full nutritional breakdown
   - **History View**: List saved meals by subject and date, re-use or delete

6. **Data Loading**: Dataset included in app bundle
   - JSON format (~7000 food records)
   - Bilingual descriptions (English/French)
   - Fields: FoodDescription, FoodDescriptionF, Protein (203), Fat (204), Carbs (205), Fiber (291), FctGluc
   - Loaded on first run, cached in IndexedDB

## API Specifications

### IndexedDB Schema

#### `nutrientsFile` Store

```typescript
interface NutrientRecord {
  id: string;                    // FOOD_ID
  FoodDescription: string;       // Food name (English)
  FoodDescriptionF: string;      // Food name (French)
  FoodGroup: string;             // Food group classification
  measure: string;               // Default serving unit
  measureF: string;              // Serving unit (French)
  nutrient_203: number;          // Protein (g)
  nutrient_204: number;          // Fat (g)
  nutrient_205: number;          // Carbohydrates (g)
  nutrient_291: number;          // Fiber (g)
  FctGluc: number;               // Estimated carb factor for glucose
}
```

#### `subjects` Store

```typescript
interface Subject {
  id: string;                    // Unique identifier
  name: string;                  // Subject name
  isActive: boolean;             // Currently selected subject
  created: number;               // Timestamp
}

// Indexes:
// - "by-active": isActive
// - "by-name": name
```

#### `mealHistory` Store

```typescript
interface MealRecord {
  id: string;                    // UUID
  subjectId: string;             // Subject identifier
  date: number;                  // Timestamp
  foods: MealItem[];             // Array of foods
  totals: {
    protein: number;
    fat: number;
    carbs: number;
    fiber: number;
  };
}

interface MealItem {
  foodId: string;
  FoodDescription: string;
  quantity: number;
  measure: string;
  nutrient_203: number;          // Protein
  nutrient_204: number;          // Fat
  nutrient_205: number;          // Carbs
  nutrient_291: number;          // Fiber
}
```

#### `favoriteNutrients` Store

```typescript
interface FavoriteFood {
  foodId: string;
  FoodDescription: string;
  FoodDescriptionF: string;
}

// Key: 'current' (singleton)
```

#### `sessions` Store

```typescript
interface Session {
  id: string;                    // Session UUID
  userId: string;                // Active subject
  lastAccess: number;            // Timestamp
}

// Key: 'current' (singleton)
```

### Core Composables/Functions

#### `useIndexedDB()`

```typescript
export function useIndexedDB() {
  // Initialize database and load dataset from JSON
  async function initializeDB(): Promise<void>
  
  // Search operations
  async function searchFoods(query: string): Promise<NutrientRecord[]>
  
  // Subject operations
  async function getSubjects(): Promise<Subject[]>
  async function createSubject(name: string): Promise<string>
  async function getActiveSubject(): Promise<Subject | null>
  async function setActiveSubject(id: string): Promise<void>
  
  // Meal history operations
  async function saveMeal(meal: MealRecord): Promise<string>
  async function getMealsBySubject(subjectId: string): Promise<MealRecord[]>
  async function deleteMeal(mealId: string): Promise<void>
  
  // Favorites operations
  async function getFavorites(): Promise<FavoriteFood[]>
  async function addFavorite(food: NutrientRecord): Promise<void>
  async function removeFavorite(foodId: string): Promise<void>
  
  return { 
    initializeDB, searchFoods, getSubjects, createSubject, 
    getActiveSubject, setActiveSubject, saveMeal, getMealsBySubject, 
    deleteMeal, getFavorites, addFavorite, removeFavorite 
  }
}
```

#### `useNutrientSearch()`

```typescript
export function useNutrientSearch(db: IDBDatabase) {
  const results = ref<NutrientRecord[]>([])
  const query = ref('')
  const loading = ref(false)
  
  // Fuzzy search with configurable options
  async function search(q: string): Promise<void>
  
  return { query, results, loading, search }
}
```

#### `useMealCalculator()`

```typescript
export function useMealCalculator() {
  interface MealItem {
    foodId: string
    FoodDescription: string
    quantity: number
    measure: string
    nutrient_203: number
    nutrient_204: number
    nutrient_205: number
    nutrient_291: number
  }

  const items = ref<MealItem[]>([])
  
  const totals = computed(() => ({
    protein: items.value.reduce((sum, item) => sum + (item.nutrient_203 * item.quantity / 100), 0),
    fat: items.value.reduce((sum, item) => sum + (item.nutrient_204 * item.quantity / 100), 0),
    carbs: items.value.reduce((sum, item) => sum + (item.nutrient_205 * item.quantity / 100), 0),
    fiber: items.value.reduce((sum, item) => sum + (item.nutrient_291 * item.quantity / 100), 0),
  }))
  
  function addItem(food: NutrientRecord, quantity: number): void
  function removeItem(index: number): void
  function updateItemQuantity(index: number, quantity: number): void
  function clearMeal(): void
  
  return { items, totals, addItem, removeItem, updateItemQuantity, clearMeal }
}
```

## Implementation Summary

v0.1 includes the following completed components:

### 1. Project Infrastructure

- Vue 3 Composition API with TypeScript strict mode
- Vite build tool and dev server
- ESLint and code quality tooling
- vite-plugin-pwa for Service Worker support
- Workbox caching strategy (3MB cache limit)

### 2. State Management

Pinia stores:

- `nutrientsFile`: Dataset storage and fuzzy search
- `meal`: Current meal calculation state
- `mealHistory`: Persistent meal records
- `subject`: Multi-subject profiles
- `session`: Session state

### 3. Data Persistence

IndexedDB with comprehensive schema:

- `nutrientsFile` store: ~7000 food records
- `subjects` store: User profiles with indexes
- `mealHistory` store: Complete meal data with nutrients
- `favoriteNutrients` store: Favorite foods
- `sessions` store: Session tracking
- Proper indexing by subject, date, name, and active status
- Date serialization/deserialization handling

### 4. Dataset Integration

- Canadian Nutrient File (~7000 foods)
- Bilingual descriptions (English/French)
- Fields: Protein (203), Fat (204), Carbs (205), Fiber (291), FctGluc
- Loaded from JSON bundle on first run
- Cached in IndexedDB for offline use

### 5. Search Functionality

- Fuse.js fuzzy search implementation
- Search across bilingual descriptions
- In-memory result caching
- Configurable search thresholds
- Favorites system for quick access

### 6. Calculator

- Multi-nutrient support: carbs, protein, fat, fiber
- Add/remove foods to current meal
- Quantity support with serving unit conversion
- Real-time total calculations
- Bootstrap 5 responsive layout

### 7. Multi-Subject Tracking

- Create and manage multiple subject profiles
- Switch between subjects
- Independent meal history per subject
- Persistent subject data across sessions

### 8. Meal History

- Store complete meal details (all foods and nutrients)
- Retrieve meals by subject and date
- Delete meals
- No data loss across app restarts

### 9. UI Components

- Navigation bar with bilingual support
- Footer component
- Search view
- Calculator view
- History view
- Subject/settings management
- Bootstrap 5 responsive design

### 10. Internationalization

- vue-i18n configuration
- Full English/French localization
- Bilingual UI and data descriptions

### 11. Testing

- Vitest unit testing with @vitest/coverage-v8
- Playwright E2E testing with @axe-core/playwright
- 3 E2E test files:
  - `accessibility.spec.ts`: WCAG accessibility validation
  - `installation.spec.ts`: PWA installation flow
  - `vue.spec.ts`: Basic Vue functionality
- 2 component unit tests: BaseFooter, BaseNavigationBar

### 12. Accessibility

- Semantic HTML
- ARIA labels
- Keyboard navigation
- Color contrast compliance
- Lighthouse accessibility score ≥ 95

### 13. PWA Foundation

- Service Worker registration configured
- vite-plugin-pwa setup
- Workbox caching
- Offline-first architecture
- Manifest.json and app icons: v0.2

## Testing Strategy

### Unit Tests (Vitest)

Files:

- Composable tests for useIndexedDB, useNutrientSearch, useMealCalculator
- Component tests for BaseFooter, BaseNavigationBar
- Store tests for Pinia state management

Coverage: Critical paths tested with focus on data persistence and calculations.

### E2E Tests (Playwright)

Test files:

- `accessibility.spec.ts`: WCAG accessibility compliance validation
- `installation.spec.ts`: PWA installation and offline capability
- `vue.spec.ts`: Basic Vue component functionality

### Performance Benchmarks

- Search: 50+ results returned in < 2 seconds
- Calculator: Totals update on quantity change < 100ms
- App startup: Interactive UI within < 3 seconds

## Deployment

Production build created via `npm run build`, which:

- Bundles Vue components and TypeScript
- Generates Service Worker via vite-plugin-pwa
- Creates hashed asset files for cache busting
- Outputs static files ready for static host deployment

Deployment target: Static host (GitHub Pages, Netlify, etc.) with HTTP/HTTPS support for Service Worker.

## Rollback

If issues occur after deployment:

- Revert commit and redeploy to revert code
- Service Worker cache busting occurs automatically with new deployment
- User data in IndexedDB remains unaffected across versions

## Monitoring

### Web Vitals

Performance targets:

- **LCP (Largest Contentful Paint)**: < 2.5 seconds
- **FCP (First Contentful Paint)**: < 1.8 seconds
- **TBT (Total Blocking Time)**: < 200ms

Measured via browser Performance API during development.

### Error Tracking

Potential errors to monitor:

- IndexedDB quota exceeded errors
- Service Worker registration failures
- Dataset loading errors
- Corrupt data detection

## Success Criteria Summary

### From Release Document

- Search returns foods in < 2 seconds
- Carb calculator works accurately (validated against CNF data)
- Full dataset loads and persists via IndexedDB
- Service Worker registration configured
- Lighthouse accessibility score ≥ 95
- Multi-subject tracking stores and retrieves meal history
- Bilingual interface (EN/FR) fully functional
- Works offline for search, calculation, and history viewing

### Implementation Status

- App installs as PWA (add to home screen capability confirmed)
- Pinia stores manage all application state (5 stores)
- IndexedDB properly initialized with comprehensive schema
- Fuse.js provides fast fuzzy search across dataset
- All meal history data persists across sessions
- Bootstrap 5 provides responsive mobile-first layout
- Vitest and Playwright test suites configured
- Service Worker caching strategy implemented
- Vue-i18n bilingual support active

## Out of Scope for v0.1

- PWA manifest.json and app icons (v0.2)
- Comprehensive test coverage expansion (v0.2)
- Performance monitoring and optimization (v0.4)
- Dataset sharding and versioning (v0.3)
- History export/import functionality (v0.6)

## Technical Considerations

### TypeScript & Vue 3 Best Practices

**Type Safety**:

- All composables and store actions have explicit return types
- Pinia stores use TypeScript interfaces for mutations
- Vue components use `<script setup>` with explicit prop interfaces
- Reactive values consistently use `ref<T>` pattern

**Composable Pattern** (`useIndexedDB`):

```typescript
export function useIndexedDB() {
  async function get(storeName: string, key: IDBValidKey): Promise<unknown>
  async function put(storeName: string, value: unknown): Promise<void>
  return { get, put } as const  // 'as const' enables type inference for callers
}
```

**Example Store** (`meal.ts`):

```typescript
export const useMealStore = defineStore('meal', () => {
  const items = ref<MealItem[]>([])

  const totals = computed(() => ({
    carbs: items.value.reduce((sum, i) => sum + i.carbs, 0)
  }))

  async function addItem(food: NutrientRecord): Promise<void> {
    // Ensure atomicity with single transaction
  }

  return { items, totals, addItem }
})
```

### Search Implementation

- Fuse.js provides fuzzy matching with configurable thresholds
- Results cached in-memory for repeated searches
- Searches across both English and French descriptions
- Performance adequate for ~7000 food records

### Data Storage & Transaction Safety

- IndexedDB schema uses proper indexing for subject, date, and name lookups
- Date serialization necessary due to IndexedDB limitations (stored as ISO strings)
- Quota handling implemented for storage errors
- **Transaction Atomicity**: Multi-operation scenarios (add meal + update subject stats) combined into single transactions
- **Continuous Persistence**: Data persists during user interaction via Pinia mutations, NOT on unload (MDN 2025 best practice)
- **No async operations in transactions**: All IndexedDB work completed before transaction scope exits

### Service Worker

- vite-plugin-pwa handles service worker generation
- Cache limit set to 3MB for Workbox strategy
- Manifest.json and icons handled in v0.2 for better control

### Multi-Subject Architecture

- Each subject maintains independent meal history
- Subject switching preserves calculation state
- Proper data isolation prevents cross-subject contamination

### Known Limitations

- No dataset update mechanism (dataset is static)
- No offline data sync for cloud backup
- Search cache grows with usage (no LRU eviction)

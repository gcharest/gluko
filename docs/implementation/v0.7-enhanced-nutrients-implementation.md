# Implementation: v0.7 Enhanced Nutrient Display & Portion Conversions

## Overview

This document provides implementation details for v0.7, which exposes comprehensive nutrient information already present in the dataset and adds support for multiple portion sizes. See the [release planning document](../releases/v0.7-enhanced-nutrients.md) for goals and context.

**Key Insight**: The dataset already contains all 152+ nutrients in the shard files. We only need to create the mapping layer and UI components to expose this data.

**Scope**:

1. **Search View**: Add expandable nutrient details (fiber, fat, vitamins, minerals, etc.)
2. **Calculator View**: Add portion size selector (cups, mL, tablespoons, etc.)

These are **separate features** serving different use cases:

- **Search**: Discovery - "What nutrients does this food contain?"
- **Calculator**: Calculation - "How many carbs in 1 cup of this food?"

## Architecture

### High-Level Flow

```text
Search View Flow:
User searches for food
    ↓
Display food card with carb factor (existing)
    ↓
User clicks "Show Nutrient Details"
    ↓
Lazy-load nutrient mapping (if not cached)
    ↓
Parse numeric codes (203, 204, etc.) from food record
    ↓
Map to human-readable names and categories
    ↓
Display organized nutrient sections (Macros, Fats, Vitamins, Minerals)

Calculator View Flow:
User adds food to meal calculator
    ↓
Display food item with default 100g portion
    ↓
Load available portions for this food (from portions array)
    ↓
User selects different portion (e.g., "1 cup")
    ↓
Apply conversion factor to all nutrient values
    ↓
Recalculate carbs and update meal totals
```

### Key Components Added in v0.7

1. **Nutrient Code Mapping**: Translate numeric codes to names
   - `NUTRIENT_CODES` constant with all 152+ nutrient codes
   - `NUTRIENT_METADATA` with names, units, categories
   - Bilingual support (EN/FR names)

2. **TypeScript Interfaces**: Type-safe data access
   - `FoodRecord` interface for shard data
   - `PortionMeasure` interface for conversion factors
   - `NutrientMetadata` interface for display info

3. **Portion Data Integration**: Add conversion factors to shards
   - ETL script to extract CONVERSION_FACTOR and MEASURE_NAME from CNF
   - Add `portions` array to each food record
   - Manifest version bump to v0.7

4. **UI Components**:
   - `NutrientDetailsCard` - Expandable nutrient display (Search view)
   - `PortionSelector` - Dropdown for portion selection (Calculator view)
   - `NutrientRow` - Individual nutrient display
   - `NutrientSection` - Categorized nutrient groups

5. **Utility Functions**:
   - `getNutrientValue()` - Extract nutrient from food record
   - `calculateForPortion()` - Apply conversion factor
   - `getNutrientsByCategory()` - Group nutrients for display
   - `formatNutrientValue()` - Format with proper precision

## API Specifications

### Updated Shard Format

#### File: `public/data/shards/shard-0000.ndjson`

Each food record now includes optional `portions` array:

```typescript
interface FoodRecord {
  FoodID: string;
  FoodCode: string;
  FoodDescription: string;
  FoodDescriptionF: string;
  FoodGroupID: string;
  FoodSourceID: string;
  FctGluc: number;  // Existing carb factor

  // Existing: All nutrients as numeric keys (152+ fields)
  '203': number;  // Protein (g)
  '204': number;  // Fat (g)
  '205': number;  // Carbohydrate (g)
  '269': number;  // Sugars (g)
  '291': number;  // Fiber (g)
  '606': number;  // Saturated fat (g)
  // ... 140+ more nutrients

  // NEW: Optional portion conversion factors
  portions?: PortionMeasure[];
}

interface PortionMeasure {
  measureId: string;
  measureName: string;      // English measure name
  measureNameF: string;     // French measure name
  conversionFactor: number; // Multiplier for 100g base
  isDefault?: boolean;      // True for "100 g" baseline
}
```

#### Example Record with Portions

```json
{
  "FoodID": "2",
  "FoodCode": "2",
  "FoodDescription": "Cheese souffle",
  "FoodDescriptionF": "Soufflé au fromage",
  "FoodGroupID": "22",
  "FoodSourceID": "20",
  "FctGluc": 0.0581,
  "203": 9.54,
  "204": 15.7,
  "205": 5.91,
  "291": 0.1,
  "portions": [
    {
      "measureId": "1",
      "measureName": "100 g",
      "measureNameF": "100 g",
      "conversionFactor": 1.0,
      "isDefault": true
    },
    {
      "measureId": "4",
      "measureName": "1 cup",
      "measureNameF": "1 tasse",
      "conversionFactor": 2.5
    },
    {
      "measureId": "7",
      "measureName": "1 serving",
      "measureNameF": "1 portion",
      "conversionFactor": 1.8
    }
  ]
}
```

### Nutrient Metadata API

#### File: `src/constants/nutrients.ts`

```typescript
export const NUTRIENT_CODES = {
  // Proximates
  PROTEIN: '203',
  FAT: '204',
  CARBOHYDRATE: '205',
  FIBER: '291',
  SUGARS: '269',
  ENERGY: '208',
  WATER: '255',
  ASH: '207',

  // Fats
  SATURATED_FAT: '606',
  MONOUNSATURATED_FAT: '645',
  POLYUNSATURATED_FAT: '646',
  TRANS_FAT: '605',
  CHOLESTEROL: '601',

  // Minerals
  CALCIUM: '301',
  IRON: '303',
  MAGNESIUM: '304',
  PHOSPHORUS: '305',
  POTASSIUM: '306',
  SODIUM: '307',
  ZINC: '309',

  // Vitamins
  VITAMIN_A: '320',
  VITAMIN_C: '401',
  VITAMIN_D: '328',
  VITAMIN_E: '323',
  VITAMIN_K: '430',
  THIAMIN: '404',
  RIBOFLAVIN: '405',
  NIACIN: '406',
  VITAMIN_B6: '415',
  FOLATE: '417',
  VITAMIN_B12: '418',

  // ... complete list of all 152 nutrients
} as const;

export interface NutrientMetadata {
  code: string;
  name: string;
  nameF: string;
  unit: string;
  category: 'macro' | 'fat' | 'mineral' | 'vitamin' | 'amino_acid' | 'other';
  displayOrder: number;
}

export const NUTRIENT_METADATA: Record<string, NutrientMetadata> = {
  '203': {
    code: '203',
    name: 'Protein',
    nameF: 'Protéines',
    unit: 'g',
    category: 'macro',
    displayOrder: 1
  },
  '204': {
    code: '204',
    name: 'Fat',
    nameF: 'Lipides',
    unit: 'g',
    category: 'macro',
    displayOrder: 2
  },
  '205': {
    code: '205',
    name: 'Carbohydrate',
    nameF: 'Glucides',
    unit: 'g',
    category: 'macro',
    displayOrder: 3
  },
  // ... metadata for all 152 nutrients
};

export const NUTRIENT_CATEGORIES = {
  macro: {
    name: 'Macronutrients',
    nameF: 'Macronutriments',
    codes: ['203', '204', '205', '291', '269', '208']
  },
  fat: {
    name: 'Fats',
    nameF: 'Lipides',
    codes: ['606', '645', '646', '605', '601']
  },
  mineral: {
    name: 'Minerals',
    nameF: 'Minéraux',
    codes: ['301', '303', '304', '305', '306', '307', '309']
  },
  vitamin: {
    name: 'Vitamins',
    nameF: 'Vitamines',
    codes: ['320', '401', '328', '323', '430', '404', '405', '406', '415', '417', '418']
  }
} as const;
```

### Utility Functions API

#### File: `src/composables/useNutrients.ts`

```typescript
import type { FoodRecord, PortionMeasure } from '@/types/food';
import { NUTRIENT_METADATA, NUTRIENT_CATEGORIES } from '@/constants/nutrients';

export function useNutrients() {
  /**
   * Extract nutrient value from food record
   */
  function getNutrientValue(food: FoodRecord, code: string): number | null {
    const value = food[code];
    return typeof value === 'number' ? value : null;
  }

  /**
   * Calculate nutrient value for a specific portion
   */
  function calculateForPortion(value: number, portion: PortionMeasure): number {
    return value * portion.conversionFactor;
  }

  /**
   * Get all nutrients organized by category
   */
  function getNutrientsByCategory(food: FoodRecord) {
    const result: Record<string, Array<{ code: string; value: number; metadata: NutrientMetadata }>> = {};

    Object.entries(NUTRIENT_CATEGORIES).forEach(([category, config]) => {
      result[category] = config.codes
        .map(code => ({
          code,
          value: getNutrientValue(food, code),
          metadata: NUTRIENT_METADATA[code]
        }))
        .filter(item => item.value !== null && item.value > 0);
    });

    return result;
  }

  /**
   * Format nutrient value with appropriate precision
   */
  function formatNutrientValue(value: number, unit: string): string {
    if (unit === 'mg' || unit === 'μg') {
      return value.toFixed(2);
    }
    if (value < 1) {
      return value.toFixed(2);
    }
    if (value < 10) {
      return value.toFixed(1);
    }
    return value.toFixed(0);
  }

  /**
   * Get default portion (100g) or first available
   */
  function getDefaultPortion(food: FoodRecord): PortionMeasure {
    if (!food.portions || food.portions.length === 0) {
      return {
        measureId: '1',
        measureName: '100 g',
        measureNameF: '100 g',
        conversionFactor: 1.0,
        isDefault: true
      };
    }

    return food.portions.find(p => p.isDefault) || food.portions[0];
  }

  return {
    getNutrientValue,
    calculateForPortion,
    getNutrientsByCategory,
    formatNutrientValue,
    getDefaultPortion
  };
}
```

## Task Breakdown

### Phase 1: Data Layer - Portion Integration (3 days)

**Goal**: Add portion conversion data to existing shards

#### Task 1.1: Extract Portion Data from CNF

- [ ] Read CONVERSION_FACTOR.csv from CNF raw data
- [ ] Read MEASURE_NAME.csv from CNF raw data
- [ ] Join tables on MeasureID
- [ ] Group conversion factors by FoodID
- [ ] Create lookup map: FoodID → PortionMeasure[]

**Acceptance Criteria**:

- Extraction script successfully parses CNF CSV files
- Portion data grouped by FoodID
- Data includes both EN and FR measure names
- Conversion factors validated (all > 0)

#### Task 1.2: Update ETL Script

- [ ] Modify existing shard generation script
- [ ] Add `portions` array to each food record
- [ ] Include only portions with valid conversion factors
- [ ] Mark "100 g" as default portion (conversionFactor = 1.0)
- [ ] Test with small dataset first

**Acceptance Criteria**:

- Updated shard files include `portions` array
- All portions have required fields (measureId, measureName, measureNameF, conversionFactor)
- 100g portion marked as default
- No breaking changes to existing fields

#### Task 1.3: Regenerate Shards and Update Manifest

- [ ] Run updated ETL script on full CNF dataset
- [ ] Generate new shard files with portions
- [ ] Update manifest.json version to "0.7.0"
- [ ] Update manifest checksums
- [ ] Test data loading in dev environment

**Acceptance Criteria**:

- All shard files regenerated with portions
- Manifest version updated to 0.7.0
- Checksums match actual file contents
- Data loads successfully in IndexedDB
- No regression in existing search/calculator functionality

---

### Phase 2: Type System & Constants (2 days)

**Goal**: Create type-safe interfaces and nutrient mappings

#### Task 2.1: Define TypeScript Interfaces

- [ ] Create `types/food.ts` with FoodRecord interface
- [ ] Create PortionMeasure interface
- [ ] Create NutrientMetadata interface
- [ ] Update existing types to use new interfaces
- [ ] Run type-check to ensure no breaking changes

**Acceptance Criteria**:

- All interfaces documented with JSDoc
- Existing code compiles without type errors
- New interfaces exported from types barrel file

#### Task 2.2: Create Nutrient Constants

- [ ] Create `constants/nutrients.ts`
- [ ] Define NUTRIENT_CODES constant (all 152 codes)
- [ ] Define NUTRIENT_METADATA with names, units, categories
- [ ] Define NUTRIENT_CATEGORIES for grouping
- [ ] Add bilingual support (EN/FR names)
- [ ] Reference CNF User Guide for accurate names and units

**Acceptance Criteria**:

- All 152 nutrient codes mapped
- Each nutrient has EN and FR name
- Units match CNF specification
- Categories defined (macro, fat, mineral, vitamin, amino_acid, other)
- Constants are type-safe (use `as const`)

#### Task 2.3: Create Utility Composable

- [ ] Create `composables/useNutrients.ts`
- [ ] Implement `getNutrientValue()`
- [ ] Implement `calculateForPortion()`
- [ ] Implement `getNutrientsByCategory()`
- [ ] Implement `formatNutrientValue()`
- [ ] Implement `getDefaultPortion()`
- [ ] Add unit tests for each function

**Acceptance Criteria**:

- All utility functions tested
- Edge cases handled (missing nutrients, null values)
- Functions properly typed
- Performance: <1ms per function call

---

### Phase 3: UI Components - Search View (4 days)

**Goal**: Display expandable nutrient details in search results

#### Task 3.1: Create NutrientRow Component

- [ ] Create `components/NutrientRow.vue`
- [ ] Props: nutrient code, value, metadata
- [ ] Display: name, value, unit
- [ ] Handle zero/null values gracefully
- [ ] Add proper ARIA labels
- [ ] Style following design system

**Acceptance Criteria**:

- Component renders nutrient name and value
- Proper formatting based on value magnitude
- Accessible to screen readers
- Matches existing design system

#### Task 3.2: Create NutrientSection Component

- [ ] Create `components/NutrientSection.vue`
- [ ] Props: category name, nutrient array
- [ ] Render category header
- [ ] Render NutrientRow for each nutrient
- [ ] Handle empty categories
- [ ] Collapsible sections (optional enhancement)

**Acceptance Criteria**:

- Category sections clearly labeled
- Nutrients grouped logically
- Empty categories hidden
- Proper spacing and layout

#### Task 3.3: Create NutrientDetailsCard Component

- [ ] Create `components/NutrientDetailsCard.vue`
- [ ] Props: food record, expanded state
- [ ] Toggle button to show/hide details
- [ ] Lazy-load nutrient data when expanded
- [ ] Use `useNutrients()` composable
- [ ] Render NutrientSection for each category
- [ ] Add loading state
- [ ] Add animation for expand/collapse

**Acceptance Criteria**:

- Details collapsed by default
- Smooth expand/collapse animation
- Keyboard accessible (Space/Enter to toggle)
- Focus management on expand
- Performance: <100ms to expand
- Screen reader announces state changes

#### Task 3.4: Integrate into SearchView

- [ ] Update SearchResultCard to include NutrientDetailsCard
- [ ] Maintain existing carb factor display
- [ ] Position "Show Details" button appropriately
- [ ] Test with various foods (with/without many nutrients)
- [ ] Ensure mobile responsiveness

**Acceptance Criteria**:

- Search results show expandable details
- Existing functionality not affected
- Works on mobile and desktop
- No performance regression in search

---

### Phase 4: UI Components - Calculator View (3 days)

**Goal**: Add portion selector to meal calculator

#### Task 4.1: Create PortionSelector Component

- [ ] Create `components/PortionSelector.vue`
- [ ] Props: food record, selected portion
- [ ] Emit: portion-changed event
- [ ] Dropdown/select element with portions
- [ ] Display measure name (use i18n locale for EN/FR)
- [ ] Show "(default)" for 100g portion
- [ ] Handle foods without portions (show 100g only)

**Acceptance Criteria**:

- Dropdown renders all available portions
- Default portion selected initially
- Emits event when selection changes
- Accessible (keyboard navigable, proper labels)
- Shows measure names in user's language

#### Task 4.2: Update Meal Store for Portions

- [ ] Add `selectedPortion` field to meal item interface
- [ ] Update `addNutrient()` to accept portion
- [ ] Update carb calculation to use portion conversion factor
- [ ] Ensure portion saved with meal in IndexedDB
- [ ] Update meal history to include portion info

**Acceptance Criteria**:

- Meal items store selected portion
- Carb calculations use conversion factor
- Portion persisted in meal history
- No breaking changes to existing meals

#### Task 4.3: Integrate PortionSelector into Calculator

- [ ] Update MealCalculatorItem component
- [ ] Add PortionSelector below food name
- [ ] Wire up portion-changed event
- [ ] Recalculate carbs when portion changes
- [ ] Update UI to show portion in summary
- [ ] Test with various foods and portions

**Acceptance Criteria**:

- Portion selector visible in calculator
- Carbs update immediately on portion change
- Portion displayed in meal summary
- Mobile responsive layout
- Smooth UX (no jarring recalculations)

---

### Phase 5: Internationalization (1 day)

**Goal**: Add i18n support for new strings

#### Task 5.1: Add Translation Keys

- [ ] Add `nutrients.*` keys to EN locale
- [ ] Add `nutrients.*` keys to FR locale
- [ ] Add nutrient category names
- [ ] Add UI strings (show/hide details, select portion)
- [ ] Update nutrient names to use i18n (or use NUTRIENT_METADATA)

**Acceptance Criteria**:

- All new UI strings translated
- EN and FR translations complete
- No hardcoded strings in components
- Translations match CNF official terminology

---

### Phase 6: Testing & Polish (2 days)

**Goal**: Ensure quality and accessibility

#### Task 6.1: Unit Tests

- [ ] Test `useNutrients()` composable
  - getNutrientValue with valid/invalid codes
  - calculateForPortion with various factors
  - getNutrientsByCategory grouping
  - formatNutrientValue edge cases
  - getDefaultPortion with/without portions
- [ ] Test NutrientRow component rendering
- [ ] Test PortionSelector component events
- [ ] Run coverage report (target: 80%+ on new code)

**Acceptance Criteria**:

- All utility functions tested
- Component tests passing
- 80%+ coverage on new code
- Edge cases covered (null, zero, missing data)

#### Task 6.2: E2E Tests

- [ ] Test: Expand nutrient details in search
- [ ] Test: Verify nutrients displayed correctly
- [ ] Test: Change portion in calculator
- [ ] Test: Verify carbs recalculate
- [ ] Test: Save meal with non-default portion
- [ ] Test: View meal in history shows portion

**Acceptance Criteria**:

- E2E tests pass consistently
- Critical user flows covered
- Tests run in CI pipeline

#### Task 6.3: Accessibility Audit

- [ ] Run axe-core on NutrientDetailsCard
- [ ] Run axe-core on PortionSelector
- [ ] Test keyboard navigation (Tab, Enter, Space)
- [ ] Test screen reader announcements
- [ ] Verify ARIA labels and roles
- [ ] Check color contrast (WCAG AA)

**Acceptance Criteria**:

- No axe-core violations
- Fully keyboard navigable
- Screen reader friendly
- WCAG AA compliant

#### Task 6.4: Performance Testing

- [ ] Profile expand animation performance
- [ ] Test with foods having 100+ nutrients
- [ ] Verify lazy loading works
- [ ] Check memory usage with many expanded cards
- [ ] Test on low-end mobile device

**Acceptance Criteria**:

- Expand animation <100ms
- Portion change recalculation <50ms
- No memory leaks
- Smooth UX on low-end devices

---

## Implementation Timeline

**Total: 15 days (3 weeks)**

| Phase | Days | Dependencies | Status |
|-------|------|--------------|--------|
| Phase 1: Data Layer | 3 | None | ⏳ Planned |
| Phase 2: Type System | 2 | Phase 1 | ⏳ Planned |
| Phase 3: Search View | 4 | Phase 2 | ⏳ Planned |
| Phase 4: Calculator View | 3 | Phase 2 | ⏳ Planned |
| Phase 5: I18n | 1 | Phase 3, 4 | ⏳ Planned |
| Phase 6: Testing | 2 | All phases | ⏳ Planned |

**Parallelization Opportunities**:

- Phase 3 and Phase 4 can be developed in parallel after Phase 2
- Phase 5 can start once component structure is defined

---

## Testing Strategy

### Unit Tests

```typescript
// tests/composables/useNutrients.test.ts
describe('useNutrients', () => {
  const mockFood: FoodRecord = {
    FoodID: '1',
    FoodDescription: 'Test Food',
    '203': 10.5,  // Protein
    '204': 5.2,   // Fat
    '205': 20.0,  // Carbs
    portions: [
      { measureId: '1', measureName: '100 g', measureNameF: '100 g', conversionFactor: 1.0, isDefault: true },
      { measureId: '2', measureName: '1 cup', measureNameF: '1 tasse', conversionFactor: 2.5 }
    ]
  };

  describe('getNutrientValue', () => {
    it('returns value for valid nutrient code', () => {
      const { getNutrientValue } = useNutrients();
      expect(getNutrientValue(mockFood, '203')).toBe(10.5);
    });

    it('returns null for missing nutrient', () => {
      const { getNutrientValue } = useNutrients();
      expect(getNutrientValue(mockFood, '999')).toBeNull();
    });
  });

  describe('calculateForPortion', () => {
    it('applies conversion factor correctly', () => {
      const { calculateForPortion } = useNutrients();
      const portion = mockFood.portions![1]; // 1 cup = 2.5x
      expect(calculateForPortion(10, portion)).toBe(25);
    });

    it('handles default portion (factor 1.0)', () => {
      const { calculateForPortion } = useNutrients();
      const portion = mockFood.portions![0]; // 100g = 1.0x
      expect(calculateForPortion(10, portion)).toBe(10);
    });
  });
});
```

### E2E Tests

```typescript
// tests/e2e/nutrient-display.spec.ts
test('expand and collapse nutrient details in search', async ({ page }) => {
  await page.goto('/search');
  await page.fill('[data-testid="search-input"]', 'cheese');
  await page.waitForSelector('[data-testid="search-result"]');

  const firstResult = page.locator('[data-testid="search-result"]').first();

  // Initially collapsed
  await expect(firstResult.locator('[data-testid="nutrient-details"]')).toBeHidden();

  // Expand
  await firstResult.locator('[data-testid="show-details-btn"]').click();
  await expect(firstResult.locator('[data-testid="nutrient-details"]')).toBeVisible();

  // Verify nutrient categories rendered
  await expect(firstResult.locator('[data-testid="nutrient-section-macro"]')).toBeVisible();
  await expect(firstResult.locator('[data-testid="nutrient-section-fat"]')).toBeVisible();

  // Collapse
  await firstResult.locator('[data-testid="hide-details-btn"]').click();
  await expect(firstResult.locator('[data-testid="nutrient-details"]')).toBeHidden();
});

test('change portion in calculator and verify carb recalculation', async ({ page }) => {
  await page.goto('/calculator');

  // Add a food
  await page.fill('[data-testid="food-search"]', 'milk');
  await page.click('[data-testid="add-food-btn"]');

  // Verify default portion (100g)
  await expect(page.locator('[data-testid="portion-selector"]')).toHaveValue('1'); // 100g
  const initialCarbs = await page.locator('[data-testid="carb-value"]').textContent();

  // Change to 1 cup
  await page.selectOption('[data-testid="portion-selector"]', '2'); // 1 cup

  // Verify carbs recalculated
  const newCarbs = await page.locator('[data-testid="carb-value"]').textContent();
  expect(newCarbs).not.toBe(initialCarbs);
});
```

---

## Deployment Steps

### Prerequisites

- [ ] v0.6 deployed and stable
- [ ] CNF raw data files available (CONVERSION_FACTOR.csv, MEASURE_NAME.csv)
- [ ] ETL scripts tested on sample data
- [ ] All tests passing

### Step 1: Data Preparation

1. Run updated ETL script to generate new shards with portions
2. Verify shard structure with sample checks
3. Update manifest.json to version 0.7.0
4. Calculate and verify checksums

### Step 2: Code Deployment

1. Merge feature branch to main
2. Run full test suite
3. Build production bundle
4. Deploy to staging environment
5. Test on staging (manual + E2E)

### Step 3: Data Deployment

1. Upload new shard files to GitHub Pages
2. Upload updated manifest.json
3. Verify files accessible via CDN

### Step 4: Release

1. Tag release v0.7.0
2. Deploy to production
3. Monitor IndexedDB migrations
4. Watch for errors in Sentry/logging

### Step 5: Verification

1. Test expandable nutrients on production
2. Test portion selection on production
3. Verify bilingual support (EN/FR)
4. Check accessibility with screen reader
5. Monitor performance metrics

---

## Rollback Plan

If critical issues arise:

1. **Data Issues**: Revert manifest.json to v0.6, users will download old shards
2. **UI Issues**: Deploy previous version, users will use cached old version
3. **Migration Issues**: Clear IndexedDB and reload (users may lose unsaved data)

**Mitigation**:

- Extensive testing in staging before production deploy
- Gradual rollout (monitor error rates)
- Feature flags to disable portions/nutrients if needed

---

## Success Metrics

### Functional Metrics

- [ ] 100% of foods display nutrient details when expanded
- [ ] 90%+ of foods have at least 2 portion options (100g + 1 other)
- [ ] Zero breaking changes to existing search/calculator flows
- [ ] <100ms to expand nutrient details
- [ ] <50ms to recalculate on portion change

### Quality Metrics

- [ ] 80%+ test coverage on new code
- [ ] Zero accessibility violations (axe-core)
- [ ] WCAG AA compliance
- [ ] No performance regression (Lighthouse score maintained)

### User Experience Metrics

- [ ] Users can discover comprehensive nutrient info
- [ ] Users can calculate carbs for realistic portions
- [ ] Bilingual users see proper translations
- [ ] Mobile users have smooth experience

---

## Known Risks and Mitigations

### Risk 1: Incomplete Portion Data

**Problem**: Some foods may not have conversion factors in CNF data
**Impact**: Portion selector shows only 100g
**Mitigation**: Graceful fallback to 100g-only, document which food groups lack portions

### Risk 2: Performance with Many Nutrients

**Problem**: Rendering 152 nutrients could be slow
**Impact**: Laggy expand animation
**Mitigation**: Lazy rendering, virtual scrolling if needed, show only top 20 nutrients by default with "Show all" option

### Risk 3: Translation Accuracy

**Problem**: Nutrient names may not match official CNF French terms
**Impact**: Confusion for French users
**Mitigation**: Extract names directly from CNF NUTRIENT_NAME.csv, validate translations

### Risk 4: Mobile Screen Space

**Problem**: Long nutrient lists may overwhelm small screens
**Impact**: Poor UX on mobile
**Mitigation**: Collapsible sections, show only non-zero nutrients, prioritize important nutrients

---

## Related Documentation

- **Release plan**: [v0.7-enhanced-nutrients.md](../releases/v0.7-enhanced-nutrients.md)
- **Previous implementation**: [v0.6-history-export-implementation.md](v0.6-history-export-implementation.md)
- **Architecture**: [ARCHITECTURE.md](../ARCHITECTURE.md)
- **Product goals**: [PRODUCT.md](../PRODUCT.md)

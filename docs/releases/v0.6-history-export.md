# Release v0.6: History Export & Import

## Release Summary

Enable users to export and import their meal calculation history as JSON files, providing backup capability and manual data transfer between devices or accounts.

## Goals

1. **Export history**: Users can download all their meal history as a portable JSON file
2. **Import history**: Users can restore history from previously exported files
3. **Data portability**: Users own their data and can move it between devices
4. **Backup capability**: Manual backup option for users concerned about losing data
5. **Format stability**: Export format documented and versioned for future compatibility

## Constraints Specific to This Release

- **No backend**: Export/import entirely local, no server involved
- **File handling**: Works in browser with FileReader/Blob APIs
- **Schema version**: Include schema version in export to handle future changes
- **Data privacy**: All data stays on user's device during export/import
- **Bilingual**: UI prompts in EN/FR

## Options Considered

### Option A: JSON export only (no import)

- **Approach**: Users can export, but can't re-import
- **Pros**: Simple, lower risk
- **Cons**: Backup is read-only, not truly portable
- **Risk**: Low but doesn't meet goals

### Option B: JSON export/import with versioning

- **Approach**: Export includes schema version; import parses and validates before loading
- **Pros**: Full data portability, handles future schema changes
- **Cons**: More complex validation logic
- **Risk**: Medium (validation must be robust)

### Option C: Cloud sync export

- **Approach**: Export to cloud service (Google Drive, OneDrive, etc.)
- **Pros**: Automatic backup, multi-device sync
- **Cons**: Requires backend/OAuth, conflicts with "no backend" constraint
- **Risk**: High (breaks architecture)

## Selected: Option B

**Why**: Gives users true portability and backup without requiring backend. Schema versioning allows graceful handling of future changes.

## Success Criteria

- [x] Users can export all history as JSON file
- [x] Export file includes schema version and export timestamp
- [x] Users can import previously exported files
- [x] Import validates schema version and structure
- [x] Imported data merges correctly with existing history (no duplicates/conflicts)
- [x] Clear UI feedback on export/import progress
- [x] Error messages help users understand issues with import files
- [x] Works with both large and small history files

## Known Risks

- **File corruption**: User edits exported JSON manually, breaks import → Validate structure strictly, show helpful error
- **Merge conflicts**: Import file has same meals as existing data → Detect duplicates, allow user to merge or replace
- **Large files**: History grows huge, export is slow → Show progress, allow async processing
- **Format changes**: Future releases change schema → Versioning handles migration

## Out of Scope

- Cloud sync or multi-device sync (future, requires backend)
- Encrypted export
- Partial export (export by subject/date range)
- CSV export (JSON only for now)

---

## Additional Feature: Meal History Detail View & Editing

### Problem Statement

Currently, `MealHistoryCard` displays only summary information (date, total carbs, nutrient count, tags, notes). Users cannot:

1. View full nutrient details of a saved meal
2. Edit an existing meal entry
3. Understand what foods/portions made up a historical calculation

The `handleEditMeal` function in `MealHistoryView.vue` is a stub (`console.log` only).

### Options Considered

#### Option A: Expand card in-place (accordion/collapsible)

- **Approach**: Add expandable section to `MealHistoryCard` showing full nutrient list
- **Pros**: 
  - Quick to view details without navigation
  - Simple implementation (toggle visibility)
  - No risk of overwriting current meal calculator state
- **Cons**: 
  - Cards become large when expanded
  - Editing in-place adds complexity to card component
  - Limited screen real estate on mobile
- **Risk**: Low for view-only; medium if editing added

#### Option B: Dedicated detail modal/dialog

- **Approach**: Open a modal overlay with full meal details and edit form
- **Pros**:
  - Clean separation of list vs detail views
  - Modal can be feature-rich without affecting list performance
  - Good for read-only viewing with optional edit mode
- **Cons**:
  - Modals on mobile can feel cramped
  - Duplicate form logic if editing (vs meal calculator)
- **Risk**: Medium

#### Option C: Navigate to meal calculator with history data (with safeguard)

- **Approach**: Load historical meal into the meal calculator; warn if unsaved work exists
- **Pros**:
  - Reuses existing meal calculator UI (no duplicate code)
  - Full editing capabilities already built
  - Familiar interface for users
- **Cons**:
  - Risk of overwriting unsaved current calculation
  - Must implement "dirty state" detection and confirmation dialog
  - Navigation flow less direct (leaves history view)
- **Risk**: Medium (safeguard logic required)

#### Option D: Side-by-side detail panel (desktop) / sheet (mobile)

- **Approach**: History list stays visible; selecting an entry opens detail panel alongside
- **Pros**:
  - Best UX for browsing multiple entries
  - No navigation required
  - Can implement read-only first, add editing later
- **Cons**:
  - More complex layout (responsive considerations)
  - Mobile requires slide-up sheet pattern
- **Risk**: Medium-high (more UI work)

### Selected: Option A + Option C (hybrid approach)

**Why**: 

1. **Option A (expandable card)** for quick **view-only** access to nutrient details. Users can see what's in a meal without leaving the history list. Low implementation risk.

2. **Option C (navigate to calculator)** for **editing**. Reuses existing calculator UI. Requires:
   - Dirty state tracking in meal store (`hasUnsavedChanges` computed)
   - Confirmation dialog before loading history entry if dirty
   - Clear "editing history entry" vs "new calculation" mode indicator
   - Option to save current work before loading, or discard

### Implementation Requirements

#### Phase 1: Expandable Card (view details)

- [ ] Add `expanded` state to `MealHistoryCard`
- [ ] Show full nutrient list when expanded (name, quantity, factor, calculated carbs)
- [ ] Accessible expand/collapse button with proper ARIA
- [ ] Smooth animation (respect `prefers-reduced-motion`)

#### Phase 2: Edit via Calculator (with safeguards)

- [ ] Add `hasUnsavedChanges` computed to meal store
- [ ] Add `loadFromHistory(entryId: string)` action to meal store
- [ ] Implement confirmation dialog component (reusable)
- [ ] Show dialog when editing history entry with unsaved calculator state
- [ ] Dialog options: "Save current & load", "Discard & load", "Cancel"
- [ ] Add visual indicator in calculator when editing a history entry
- [ ] Update history entry on save (vs creating new entry)

#### Phase 3: UX Polish

- [ ] "Edit" action in card menu navigates with safeguard
- [ ] "Duplicate" creates copy in calculator (also with safeguard)
- [ ] Success toast after loading history entry
- [ ] Breadcrumb or back button to return to history after editing

### Success Criteria (History Detail/Edit)

- [ ] Users can expand a history card to see all nutrients
- [ ] Users can edit a history entry via the meal calculator
- [ ] Unsaved calculator work is never silently overwritten
- [ ] Clear indication when editing an existing entry vs new calculation
- [ ] Edited entries update in place (same ID, updated timestamp)

### Known Risks (History Detail/Edit)

- **Dirty state detection**: Must track all changes to nutrients array → Use `watch` with `deep: true` or hash comparison
- **Edit vs new confusion**: Users may not realize they're editing history → Clear UI labeling, different save button text
- **Back navigation**: User edits, navigates away without saving → Same dirty state check on route leave

---

## Related Documentation

- **Previous release**: [v0.5-ui-polish.md](v0.5-ui-polish.md)
- **Release tracker**: [RELEASE_TRACKER.md](RELEASE_TRACKER.md)
- **Next release**: [v1.0-production-ready.md](v1.0-production-ready.md)
- Product goals: [PRODUCT.md](../PRODUCT.md)
- Architecture: [ARCHITECTURE.md](../ARCHITECTURE.md)

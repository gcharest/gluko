# Release v0.7: Enhanced Nutrient Display & Portion Conversions

## Release Summary

Expose comprehensive nutrient information already present in the dataset and add support for multiple portion sizes, enabling users to view detailed nutritional data (fiber, fat, vitamins, minerals, etc.) and calculate nutrients for various serving measures beyond the default 100g baseline.

## Goals

1. **Display comprehensive nutrients**: Show all available nutrient data (152+ nutrients) with expandable details in search results
2. **Multiple portion support**: Calculate and display nutrients for various serving sizes (cups, mL, tablespoons, etc.)
3. **Leverage existing data**: Utilize nutrient data already present in shard files (no new ETL required)
4. **Maintain simplicity**: Keep current carb-focused workflow as default while making detailed data accessible
5. **Bilingual support**: Display nutrient names and portion measures in both EN/FR

## Constraints Specific to This Release

- **No backend changes**: All nutrient data already exists in shards
- **Performance first**: Expandable details load on-demand (lazy rendering)
- **Mobile-optimized**: Nutrient display must work well on small screens
- **Accessibility**: Full keyboard navigation and screen reader support
- **Backward compatible**: Existing `FctGluc` carb factor remains primary metric

## Context

### Current State

The app already loads all CNF nutrient data into IndexedDB from shard files:
```json
{
  "203": 9.54,    // Protein (g)
  "204": 15.7,    // Fat (g)
  "205": 5.91,    // Carbohydrate (g)
  "269": 2.66,    // Sugars (g)
  "291": 0.1,     // Fiber (g)
  "606": 5.742,   // Saturated fat (g)
  // ... 140+ more nutrients
  "FoodDescription": "Cheese souffle",
  "FctGluc": 0.0581
}
```

However, the UI only displays:
- Food name
- Carb factor (FctGluc)
- Link to official CNF website

**All the rich nutrient data exists but is hidden from users.**

### What's Missing

1. **Nutrient code mapping**: No layer to convert numeric codes (203 → "Protein")
2. **Portion conversion data**: CONVERSION_FACTOR and MEASURE_NAME tables not yet integrated
3. **TypeScript interfaces**: No type-safe access to nutrient fields
4. **UI components**: No components to display or calculate nutrient values

## Options Considered

### Option A: Full nutrient dashboard (always visible)

- **Approach**: Show all nutrients in every search result card
- **Pros**: Maximum information visibility
- **Cons**: Overwhelming UI, poor mobile experience, breaks existing carb-focused workflow
- **Risk**: High (usability degradation)

### Option B: Expandable nutrient details (progressive disclosure)

- **Approach**: Show carb factor by default; expand to see full nutrient breakdown
- **Pros**:
  - Maintains current simple workflow
  - Progressive disclosure reduces cognitive load
  - Lazy rendering improves performance
  - Works well on mobile (accordion pattern)
- **Cons**: Requires extra click to see details
- **Risk**: Low

### Option C: Separate "Nutrition Facts" view

- **Approach**: Navigate to dedicated page to see full nutrient info
- **Pros**: Clean separation, can show more detailed analysis
- **Cons**: Breaks search flow, extra navigation step
- **Risk**: Medium

## Selected: Option B (Expandable Details)

**Why**:
- Preserves existing carb-focused workflow as default
- Progressive disclosure pattern is familiar and mobile-friendly
- Lazy rendering keeps initial load fast
- Users who need detailed nutrients can access them without leaving search context

## Success Criteria

- [x] Food search results show expandable nutrient details (collapsed by default)
- [ ] Nutrient display includes categories: Macros, Fats, Vitamins, Minerals
- [ ] All 152+ nutrients accessible with proper names and units
- [ ] Portion selector dropdown shows available measures (cups, mL, etc.)
- [ ] Nutrient values update reactively when portion changes
- [ ] Default portion remains 100g (maintains current behavior)
- [ ] Bilingual nutrient names and units (EN/FR)
- [ ] Keyboard accessible (expand/collapse, portion selection)
- [ ] Screen reader announces nutrient values properly
- [ ] Performance: <100ms to expand details, <50ms to recalculate on portion change

## Architecture

### Phase 1: Data Layer (3 days)

**Goal**: Add portion conversion data to existing shards

1. Extract CONVERSION_FACTOR and MEASURE_NAME from CNF CSVs
2. Add `portions` array to shard records:
   ```json
   {
     "FoodID": "2",
     "FoodDescription": "Cheese souffle",
     "203": 9.54,
     "portions": [
       {
         "measureId": "1",
         "measureName": "100 g",
         "measureNameF": "100 g",
         "conversionFactor": 1.0,
         "isDefault": true
       },
       {
         "measureId": "4",
         "measureName": "1 cup",
         "measureNameF": "1 tasse",
         "conversionFactor": 2.5
       }
     ]
   }
   ```
3. Update manifest version
4. Test data loading

### Phase 2: Type System & Utilities (2 days)

**Goal**: Type-safe access to nutrient data

1. Create `NUTRIENT_CODES` constant mapping:
   ```typescript
   export const NUTRIENT_CODES = {
     PROTEIN: '203',
     FAT: '204',
     CARBOHYDRATE: '205',
     FIBER: '291',
     SUGARS: '269',
     // ... all 152 nutrients
   } as const;

   export const NUTRIENT_METADATA: Record<string, NutrientMeta> = {
     '203': { name: 'Protein', nameF: 'Protéines', unit: 'g', category: 'macro' },
     '204': { name: 'Fat', nameF: 'Lipides', unit: 'g', category: 'macro' },
     // ...
   };
   ```

2. Create TypeScript interfaces:
   ```typescript
   interface FoodRecord {
     FoodID: string;
     FoodDescription: string;
     FoodDescriptionF: string;
     FctGluc: number;
     portions?: PortionMeasure[];
     [nutrientCode: string]: number | string | PortionMeasure[] | undefined;
   }

   interface PortionMeasure {
     measureId: string;
     measureName: string;
     measureNameF: string;
     conversionFactor: number;
     isDefault?: boolean;
   }
   ```

3. Create utility functions:
   ```typescript
   function getNutrientValue(food: FoodRecord, code: string): number | null;
   function calculateForPortion(value: number, factor: number): number;
   function getNutrientsByCategory(food: FoodRecord): Record<string, NutrientValue[]>;
   ```

### Phase 3: UI Components (4 days)

**Goal**: Display nutrient information

1. **NutrientRow** component:
   ```vue
   <div class="nutrient-row">
     <span class="nutrient-name">{{ nutrientName }}</span>
     <span class="nutrient-value">{{ formattedValue }} {{ unit }}</span>
   </div>
   ```

2. **NutrientSection** component:
   ```vue
   <div class="nutrient-section">
     <h4>{{ categoryTitle }}</h4>
     <NutrientRow v-for="nutrient in nutrients" :key="nutrient.code" />
   </div>
   ```

3. **PortionSelector** component:
   ```vue
   <select v-model="selectedPortion" class="portion-selector">
     <option v-for="portion in portions" :value="portion">
       {{ portion.measureName }}
     </option>
   </select>
   ```

4. **EnhancedFoodCard** component:
   ```vue
   <div class="food-card">
     <!-- Current: Name + Carb Factor -->
     <h3>{{ food.FoodDescription }}</h3>
     <p class="carb-factor">{{ food.FctGluc }}g carbs/100g</p>

     <!-- New: Portion Selector (if available) -->
     <PortionSelector v-if="food.portions" />

     <!-- New: Expandable Details -->
     <button @click="expanded = !expanded">
       {{ expanded ? 'Hide' : 'Show' }} Nutrient Details
     </button>

     <div v-if="expanded" class="nutrient-details">
       <NutrientSection v-for="category in categories" />
     </div>
   </div>
   ```

### Phase 4: Integration (2 days)

1. Update SearchView to use EnhancedFoodCard
2. Update meal calculator to accept portion-adjusted values
3. Store selected portion in session data
4. Update history cards to show portion used

### Phase 5: Testing & Polish (2 days)

1. Unit tests for nutrient utilities
2. Unit tests for portion calculations
3. Component tests for EnhancedFoodCard
4. E2E test: expand nutrients, change portion, verify values
5. Accessibility audit with axe-core
6. Performance profiling (ensure <100ms expand time)

## Implementation Timeline

**Total: 13 days (2.6 weeks)**

| Phase | Days | Status |
|-------|------|--------|
| Phase 1: Data Layer | 3 | ⏳ Planned |
| Phase 2: Type System | 2 | ⏳ Planned |
| Phase 3: UI Components | 4 | ⏳ Planned |
| Phase 4: Integration | 2 | ⏳ Planned |
| Phase 5: Testing | 2 | ⏳ Planned |

## I18n Keys Required

```json
{
  "nutrients": {
    "showDetails": "Show Nutrient Details",
    "hideDetails": "Hide Nutrient Details",
    "per100g": "per 100g",
    "portion": "Portion",
    "selectPortion": "Select portion size",
    "categories": {
      "macros": "Macronutrients",
      "fats": "Fats",
      "vitamins": "Vitamins",
      "minerals": "Minerals"
    }
  }
}
```

## Known Risks

- **Performance with many nutrients**: Rendering 152+ nutrients could be slow → Mitigate with lazy rendering, virtual scrolling if needed
- **Portion data incomplete**: Some foods may not have portions → Graceful fallback to 100g only
- **Mobile screen space**: Long nutrient lists on small screens → Categorize and use accordion pattern
- **Nutrient name translations**: Ensuring accurate FR translations → Use official CNF French names from NUTRIENT_NAME table

## Out of Scope

- Daily value percentages (% RDA) - future enhancement
- Nutrient filtering/search - future enhancement
- Custom portion entry (manual gram input) - future enhancement
- Nutrient comparison across foods - future enhancement
- Recipe builder with nutrient totals - future enhancement

## Future Enhancements

### Short-term (v0.8)
- Remember last selected portion per food
- Custom gram input for portions
- Nutrient search/filtering

### Long-term (v1.0+)
- Daily value tracking (% RDA)
- Nutrient goals and targets
- Recipe builder with nutrient aggregation
- Meal pattern analysis
- Barcode scanning integration

---

## Related Documentation

- **Implementation details**: [docs/implementation/ENHANCED_NUTRIENT_DISPLAY_AND_PORTIONS.md](../implementation/ENHANCED_NUTRIENT_DISPLAY_AND_PORTIONS.md)
- **Previous release**: [v0.6-history-export.md](v0.6-history-export.md)
- **Next release**: [v0.8-advanced-features.md](v0.8-advanced-features.md)
- **Release tracker**: [RELEASE_TRACKER.md](RELEASE_TRACKER.md)
- Product goals: [PRODUCT.md](../PRODUCT.md)
- Architecture: [ARCHITECTURE.md](../ARCHITECTURE.md)

# Release v0.4: PWA Performance Optimization

## Release Summary

Optimize the PWA's dataset loading and Web Vitals performance by implementing streaming NDJSON imports with Web Workers, enhanced Service Worker caching strategies, and chunked IndexedDB writes—achieving target Web Vitals and providing non-blocking user experience.

## Goals

1. **Streaming ingestion**: Parse and import shards without blocking main thread (use Web Workers)
2. **Chunked writes**: Write to IndexedDB in small, non-blocking transactions
3. **Service Worker caching**: Cache compressed shard responses for offline/repeat visits
4. **Improve Web Vitals**: Achieve LCP < 2.5s, FCP < 1.8s, TBT < 200ms
5. **Non-blocking imports**: App shell interactive during background dataset import

## Constraints Specific to This Release

- **Must preserve v0.2-0.3 data**: IndexedDB history and existing dataset must survive upgrade
- **Atomic updates**: Dataset must be fully imported and valid before becoming live (no partial data)
- **Mobile networks**: Design for slow/spotty networks (3G, rural areas)
- **Low-end devices**: Chunk sizes must be tuned for devices with < 4GB RAM
- **No backend changes**: Still using static file hosting

## Options Considered

### Option A: Synchronous blocking import

- **Approach**: Parse and write shards sequentially on main thread
- **Pros**: Simple implementation
- **Cons**: Blocks UI, slow on low-end devices, bad UX
- **Risk**: Low (works) but fails Web Vitals targets

### Option B: Streaming + Web Worker import

- **Approach**:
  - Dedicated Web Worker fetches, decompresses, and parses NDJSON
  - Worker writes to IndexedDB in chunked transactions
  - Main thread remains responsive
  - Service Worker caches compressed responses
- **Pros**:
  - Non-blocking UI
  - Efficient memory usage
  - Resumable progress
  - Service Worker enables offline repeats
- **Cons**: More complex (workers, streaming, chunking)
- **Risk**: Medium (new patterns, but well-established)

### Option C: Streaming with shared worker + IndexedDB worker

- **Approach**: Multiple workers, one for network, one for indexing
- **Pros**: Max parallelism, fastest imports
- **Cons**: Significantly more complex
- **Risk**: High (overkill for current needs)

## Selected: Option B

**Why**: Streaming + Web Worker gives us non-blocking UI and efficient resource usage. Option C is overkill for MVP. Option A fails performance targets.

## Success Criteria

- [ ] On identical manifest, **zero** shard downloads (repeat visits use cache only)
- [ ] On manifest change, only changed shards downloaded
- [ ] LCP < 2.5s, FCP < 1.8s, TBT < 200ms (measured on mid-tier device)
- [ ] App shell interactive before import completes
- [ ] Progress UI visible and responsive during import
- [ ] Interrupted download can resume (progress persisted)
- [ ] Import throughput ≥ 5,000 items/sec (mid-tier device)
- [ ] Chunk size ~500-2000 records per transaction (tuned per device)
- [ ] Works offline after initial import

## Known Risks

- **Storage quota**: Device runs out of space → Graceful error, offer to free space or keep partial
- **Browser variability**: IndexedDB limits differ → Test across target browsers
- **Service Worker lifecycle**: Complex interaction between SW versioning and data versioning → Clear documentation
- **Worker compatibility**: Some older browsers lack Web Worker support → Graceful fallback to main-thread import

## Out of Scope

- Automatic background updates
- Parquet or binary format (NDJSON only)
- Per-shard lazy loading (all shards loaded on sync)

## Related Documentation

- **Previous release**: [v0.3-shard-loading.md](v0.3-shard-loading.md)
- **Release tracker**: [RELEASE_TRACKER.md](RELEASE_TRACKER.md)
- **Next release**: [v0.5-ui-polish.md](v0.5-ui-polish.md)
- Product goals: [PRODUCT.md](../PRODUCT.md)
- Architecture: [ARCHITECTURE.md](../ARCHITECTURE.md)
- Implementation: [pwa-shard-ingestion.md](../implementation/pwa-shard-ingestion.md)
